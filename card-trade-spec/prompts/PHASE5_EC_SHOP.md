# Phase 5: ECショップ

## このフェーズのゴール
商品一覧・詳細ページ、カート機能、注文フローの実装。

## 指示

### 1. 商品一覧ページ `src/app/shop/page.tsx`

**フィルター** `src/components/shop/ShopFilters.tsx`:
- カテゴリフィルター: ピル型タブ（すべて/ポケモン/遊戯王/ワンピース/デジタル/その他）
- レアリティフィルター: UR / SR / R / C
- ソート: 新着順 / 価格安い順 / 価格高い順
- URLクエリパラメータで状態管理（`?category=pokemon&sort=price_asc`）

**商品グリッド** `src/components/shop/ProductGrid.tsx`:
- グリッド: 4列(xl) / 3列(lg) / 2列(sm)
- ページネーション or 「もっと見る」ボタン（12件ずつ）
- 商品が0件の場合: 「該当する商品が見つかりませんでした」

**商品カード** `src/components/shop/ProductCard.tsx`:
- **画像エリア**: 高さ200px、カテゴリカラーのグラデーション背景
  - 商品画像があれば表示、なければカテゴリアイコン
  - バッジ: NEW(青)/SALE(赤)/RARE(紫)/DIGITAL(緑)を左上に
- **情報エリア**:
  - カテゴリ名（小さく大文字で）
  - 商品名（太字）
  - レアリティ（バッジ）
  - フッター: 価格（Orbitronフォント）+ カート追加ボタン（丸い＋ボタン）
- ホバー: translateY(-6px) + shadow強化
- カート追加ボタンクリック → トースト通知「カートに追加しました」

**データ取得**:
- Server Component で Supabase から `products`（status='active'）を取得
- カテゴリ JOIN
- 画像は `product_images` から最初の1枚
- フィルター・ソートはURLパラメータ → Supabase クエリに反映

### 2. 商品詳細ページ `src/app/shop/[id]/page.tsx`

**レイアウト**: 2カラム（画像 | 情報）

**左カラム: 画像ギャラリー**:
- メイン画像（大きく表示）
- サムネイル一覧（クリックでメイン切替）
- 画像がない場合はカテゴリカラーのプレースホルダー

**右カラム: 商品情報**:
- カテゴリ（リンク付き → /shop?category=xxx）
- 商品名（大きな見出し）
- レアリティバッジ
- 価格（大きく、Orbitronフォント、税込表示）
- 元値がある場合は取消線で表示
- 状態: 未開封/美品/良品/傷あり（日本語表示）
- 説明文
- デジタルカードの場合は「🌐 デジタルカード」タグ
- 「カートに追加」ボタン（大きなprimaryボタン）
- 在庫: sold の場合は「SOLD OUT」表示、ボタン無効化

**関連商品**:
- 同カテゴリの他商品4件を表示
- ProductCard で表示

**メタデータ**: 動的生成（`generateMetadata`）

**閲覧数カウント**:
- ページ表示時に `view_count` をインクリメント

### 3. カート機能

**カートストア** `src/stores/cartStore.ts`:

zustand で実装:
```typescript
interface CartItem {
  product_id: string;
  name: string;
  price: number;
  image_url: string | null;
  category_name: string;
}

interface CartStore {
  items: CartItem[];
  addItem: (item: CartItem) => void;     // 重複チェック（カードは1点もの）
  removeItem: (productId: string) => void;
  clearCart: () => void;
  totalAmount: () => number;
  itemCount: () => number;
}
```

- `persist` ミドルウェアで localStorage 永続化
- 同一商品の追加を防止（「すでにカートに入っています」トースト）

**カートアイコン（ヘッダー）**:
- 商品数バッジ（赤い丸に数字）
- カート0件の場合はバッジ非表示

### 4. カートページ `src/app/cart/page.tsx`

**カートが空の場合**:
- 「カートに商品がありません」メッセージ
- 「ショップへ戻る」ボタン

**カートに商品がある場合**:

`src/components/shop/CartItem.tsx`:
- 商品画像（小さく）+ 商品名 + 価格 + 削除ボタン
- 合計金額（下部に大きく表示）
- 「注文に進む」ボタン

### 5. 注文フロー

**注文ページ** `src/app/cart/checkout/page.tsx`:
- 要ログイン（未ログインなら /auth/login?redirect=/cart/checkout へ）
- 注文内容確認（カートの商品一覧）
- 配送先入力フォーム:
  ```
  氏名         [テキスト]  必須
  郵便番号     [テキスト]  必須
  住所         [テキストエリア] 必須
  電話番号     [テキスト]  必須
  メール       [メール]    必須（自動入力）
  ```
- プロフィールに住所がある場合は自動入力
- 合計金額表示
- 注意書き: 「※お支払いは銀行振込となります。注文確定後、お支払い情報をメールでお送りいたします。」
- 「注文を確定する」ボタン

**注文確定処理**:
1. zodバリデーション
2. `orders` テーブルにレコード作成（order_number 自動生成）
3. `order_items` テーブルに明細作成
4. カート内の商品を `sold` ステータスに更新
5. カートをクリア
6. 管理者にメール通知
7. ユーザーに注文確認メール（注文番号、内容、支払い案内）
8. 完了ページ表示（「ご注文ありがとうございます。注文番号: ORD-XXXXXXXX-XXXX」）

**注文確認メール** `src/app/api/email/order/route.ts`:
- ユーザー向け: 注文番号、商品一覧、合計金額、振込先案内
- 管理者向け: 注文詳細、顧客情報

### 6. マイページ: 注文履歴

`src/app/mypage/orders/page.tsx`:
- ログインユーザーの注文一覧
- テーブル: 注文番号/注文日/合計金額/ステータス
- ステータスバッジ
- クリックで詳細展開（注文商品一覧、配送先、追跡番号）

## 完了条件

- [ ] 商品一覧でフィルター・ソートが正しく動作する
- [ ] 商品カードの表示が仕様通り（バッジ、カテゴリカラー）
- [ ] 商品詳細ページで画像ギャラリーが動作する
- [ ] カート追加・削除が動作する
- [ ] ヘッダーのカートバッジが正しく更新される
- [ ] カートページで商品一覧と合計金額が表示される
- [ ] 注文フロー（確認→配送先入力→確定）が一連で動作する
- [ ] 注文確定後にDBにデータが保存される
- [ ] 注文した商品がSOLD OUT状態になる
- [ ] メール通知が送信される
- [ ] マイページで注文履歴が表示される
- [ ] 全ページがモバイルレスポンシブ対応
