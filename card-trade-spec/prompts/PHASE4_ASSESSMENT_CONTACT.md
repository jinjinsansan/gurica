# Phase 4: 査定フォーム・問い合わせフォーム

## このフェーズのゴール
オンライン査定フォーム（画像アップロード付き）と問い合わせフォームの実装。メール通知連携。

## 指示

### 1. オンライン査定ページ `src/app/assessment/page.tsx`

**レイアウト**: 2カラム（lg以上）、モバイルは1カラム

**左カラム: 査定の紹介カード** `src/components/assessment/AssessmentInfo.tsx`:
- グラデーション背景（blue→purple）のカード
- タイトル: 「無料オンライン査定」
- 説明文: 「写真を送るだけで簡単査定。専門スタッフが丁寧にお見積もりいたします。」
- メリットリスト（チェックマーク付き）:
  - ✓ 査定料・送料無料
  - ✓ 最短即日回答
  - ✓ デジタルカードも対応
  - ✓ 高価買取実績多数

**右カラム: 査定フォーム** `src/components/assessment/AssessmentForm.tsx`:

'use client' コンポーネント

フォーム項目:
```
氏名        [テキスト]     必須
メール      [メール]       必須
電話番号    [電話]         任意
カテゴリ    [セレクト]     必須
            選択肢: ポケモンカード/遊戯王/ワンピースカード/デジタルカード/その他
カード詳細  [テキストエリア] 必須
            プレースホルダー: 「カード名、型番、枚数などをご記入ください」
状態        [セレクト]     必須
            選択肢: 未開封(mint)/美品(near_mint)/良品(good)/傷あり(damaged)
画像        [ファイルアップロード] 任意（最大5枚）
備考        [テキストエリア] 任意
```

**zodバリデーション** `src/lib/validators.ts` に追加:
```typescript
const assessmentSchema = z.object({
  name: z.string().min(1, '氏名を入力してください').max(50),
  email: z.string().email('正しいメールアドレスを入力してください'),
  phone: z.string().optional(),
  category_id: z.string().uuid('カテゴリを選択してください'),
  card_detail: z.string().min(1, '商品の詳細を入力してください').max(2000),
  condition: z.enum(['mint', 'near_mint', 'good', 'damaged']),
  notes: z.string().max(1000).optional(),
})
```

**画像アップロード** `src/components/ui/FileUpload.tsx`:
- ドラッグ＆ドロップ対応エリア
- 📷 アイコン + 「画像をドラッグ＆ドロップ、またはクリックして選択」
- 対応形式: jpg, png, webp
- 最大: 5枚、各5MB以下
- プレビュー表示（サムネイル）
- 削除ボタン
- アップロード中のプログレスバー
- バリデーションエラー表示（ファイルサイズ超過等）

**送信処理フロー**:
1. zodバリデーション
2. 送信ボタンをローディング状態に
3. Server Action or API Route で処理:
   a. `assessments` テーブルにレコード作成
   b. 画像をSupabase Storage `assessments/{id}/` にアップロード
   c. `assessment_images` テーブルにURL保存
   d. Resend APIで管理者に通知メール送信
   e. Resend APIでユーザーに受付確認メール送信
4. 成功 → 完了メッセージ表示（「査定リクエストを受け付けました。メールにて結果をご連絡いたします。」）
5. エラー → エラーメッセージ表示

**ログインユーザー対応**:
- ログイン中は氏名・メールを自動入力
- `user_id` を査定レコードに紐付け

### 2. メール通知 API

**査定受付通知** `src/app/api/email/assessment/route.ts`:

管理者向けメール:
- 件名: 「【新着査定】{カテゴリ名} - {ユーザー名}様」
- 内容: 申込者情報、商品詳細、画像枚数、管理画面リンク

ユーザー向けメール:
- 件名: 「【{{SITE_NAME}}】査定リクエストを受け付けました」
- 内容: 受付番号、査定内容の確認、回答予定（2営業日以内）、問い合わせ先

**Resend セットアップ** `src/lib/email/resend.ts`:
```typescript
import { Resend } from 'resend';
const resend = new Resend(process.env.RESEND_API_KEY);
```

**メールテンプレート** `src/lib/email/templates/`:
- シンプルなHTMLメール（インラインCSS）
- ヘッダー: サイト名ロゴ
- ボディ: 内容
- フッター: 会社情報

### 3. 問い合わせページ `src/app/contact/page.tsx`

**レイアウト**: 2カラム

**左カラム: 連絡方法** :
3つのカード形式:
- 📧 メール: {{EMAIL}} / 24時間受付
- 📞 電話: {{PHONE}} / 平日10:00〜18:00
- 💬 LINE: 準備中

**右カラム: 問い合わせフォーム**:

フォーム項目:
```
氏名            [テキスト]     必須
メールアドレス  [メール]       必須
お問い合わせ種別 [セレクト]    必須
                選択肢: 買取について/販売について/その他
内容            [テキストエリア] 必須
```

**送信処理**:
1. zodバリデーション
2. `contacts` テーブルにレコード作成
3. 管理者にメール通知
4. ユーザーに受付確認メール
5. 完了メッセージ表示

**問い合わせメール** `src/app/api/email/contact/route.ts`:
- 管理者向け: 問い合わせ内容の全文
- ユーザー向け: 受付確認 + 返信予定

### 4. マイページ: 査定履歴

`src/app/mypage/assessments/page.tsx`:
- ログインユーザーの査定リクエスト一覧
- テーブル: 受付日/カテゴリ/ステータス/査定額
- ステータスはバッジ表示（pending=灰/reviewing=青/quoted=緑/etc）
- クリックで詳細表示（モーダル or 展開）

## 完了条件

- [ ] 査定フォームの全フィールドが正しく動作する
- [ ] 画像アップロード（ドラッグ＆ドロップ、プレビュー、削除）が動作する
- [ ] zodバリデーションが機能する（必須チェック、形式チェック）
- [ ] 送信成功時にSupabaseにデータが保存される
- [ ] 画像がSupabase Storageにアップロードされる
- [ ] メール通知が送信される（Resend）
- [ ] 問い合わせフォームが正しく動作する
- [ ] マイページで査定履歴が表示される
- [ ] 全フォームがモバイルレスポンシブ対応
- [ ] ローディング状態・エラー状態が適切に表示される
